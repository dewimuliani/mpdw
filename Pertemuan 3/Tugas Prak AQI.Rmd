---
title: "Tugas AQI"
author: "Dewi Muliani"
date: "2025-09-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Library
```{r, echo=FALSE}
library(dLagM)
library(dynlm)
library(MLmetrics)
library(lmtest)
library(car)
library(corrplot)
library(ggplot2)
library(lubridate)
```

# Data
```{r}
data_aqi <- read.csv("C:/Users/lenovo/OneDrive/ドキュメント/Metode Peramalan Deret Waktu (MPDW)/NewDelhi_Air_quality.csv")
data_aqi
```

# Membuat matriks korelasi antar peubah dan pemilihan peubah X
```{r}
# Membuat subset variabel numerik yang relevan
data_aqi_sub <- data_aqi[, c("AQI", "CO", "no2", "o3", "pm10", "pm25", "so2")]

# Menghitung korelasi antara AQI dengan variabel lain
cor_AQI <- cor(data_aqi_sub, use = "complete.obs")

# Visualisasi korelasi
corrplot(cor_AQI, method = "color", type = "upper",
         addCoef.col = "black", # menambahkan nilai korelasi
         tl.col = "black", tl.srt = 45, # label
         diag = FALSE)
```

Berdasarkan hasil korelasi, terlihat bahwa variabel O₃ (ozon) memiliki hubungan yang paling kuat dengan AQI (0.97). Nilai ini menunjukkan adanya korelasi positif yang sangat tinggi, artinya ketika kadar ozon meningkat, nilai AQI cenderung ikut meningkat secara searah. Dibandingkan dengan variabel lain, seperti CO (0.80), NO₂ (0.74), SO₂ (-0,74), dll, hubungan antara AQI dan O₃ jauh lebih konsisten dan signifikan. 

Secara teoretis, ozon troposferik juga merupakan salah satu komponen utama dalam perhitungan indeks kualitas udara (Lestari & Aryanto, 2023), sehingga masuk akal jika O₃ menjadi prediktor yang paling dominan terhadap AQI. Maka dari itu, saya memilih O₃ sebagai peubah X karena O₃ mampu memberikan informasi paling kuat untuk menjelaskan variasi perubahan AQI dari waktu ke waktu.

# Pengecekan Asumsi
```{r}
model_awal <- lm(AQI ~ o3, data = data_aqi)
summary(model_awal)
```
## Autokorelasi Residual
```{r}
dwtest(model_awal) 
```
Berdasarkan hasil p-value < 0.05, maka Tolak H0. Hal ini menandakan ada autokorelasi positif yang signifikan pada residual model regresi.

## Normalitas Residual
```{r}
# Uji Shapiro-Wilk
shapiro.test(residuals(model_awal))
```
Berdasalkan hasil p-value < 0.05, maka Tolah H0.Sehingga, didapatkan bahwa residual tidak berdistribusi normal

## Homoskedastisitas
```{r}
bptest(model_awal)
```
Berdasakan hasil p-value (0.842) > 0.05, maka terima H0. Sehingga didapatkan bahwa ragam homogen.

# Pembagian Data
## Plot Data
```{r}
# Mengubah datetime sesuai format "YYYY-mm-dd:HH"
data_aqi$datetime <- as.POSIXct(
  data_aqi$datetime,
  format = "%Y-%m-%d:%H",
  tz = "UTC"
)

# Plot garis AQI terhadap waktu
ggplot(data_aqi, aes(x = datetime, y = AQI)) +
  geom_line(color = "blue") +
  geom_point(color = "red", size = 1) +
  labs(title = "Plot AQI terhadap Waktu",
       x = "Datetime",
       y = "AQI") +
  theme_minimal()
```

Berdasarkan plot, pembagian data yang akan saya gunakan adalah 80% untuk data training dan 20% untuk data testing. Hal ini dikarenakan pada bagian awal hingga pertengahan data (sekitar 58 data pengamatan) terlihat pola pergerakan yang cenderung lebih stabil dan konsisten. Namun, pada bagian akhir (sekitar 14 data) cenderung menampilkan kondisi yang lebih fluktuatif. Sehingga, diharapkan model memperoleh cukup informasi historis untuk mempelajari pola pergerakan AQI, sekaligus memiliki data uji yang representatif untuk mengevaluasi kemampuan peramalan. Dengan pembagian ini, model diharapkan lebih optimal dalam menangkap pola data sekaligus teruji pada kondisi terbaru.

## Split Data
```{r}
train<-data_aqi[1:58,]
test<-data_aqi[59:72,]
```

## Data Time Series
```{r}
train.ts<-ts(train)
test.ts<-ts(test)
data.ts<-ts(data_aqi)
```

# Model Koyck
```{r}
model.koyck <- koyckDlm(x = train$o3, y = train$AQI)
summary(model.koyck)
AIC(model.koyck)
BIC(model.koyck)
```

**Interpretasi Hasil:**

-   Dari `summary`, kita dapatkan model:

    $$ \hat{Y_t}=0.26260+0.25823X_t+0.42943Y_{t-1} $$

    Koefisien $X_t$ (0.25823) signifikan, artinya nilai \$X\$ saat ini berpengaruh terhadap $Y$.

-   Koefisien $Y_{t−1}$ (0.42943) juga signifikan. Ini adalah **estimasi untuk** $\lambda$. Nilai ini menunjukkan bahwa sekitar 43% dari efek di periode sebelumnya masih "terbawa" ke periode saat ini.


## Peramalan dan Akurasi
```{r}
fore.koyck <- forecast(model = model.koyck, x=test$o3, h=14)
fore.koyck
```

### data test
```{r}
mape.koyck <- MAPE(fore.koyck$forecasts, test$AQI)
mape.koyck 

```
### akurasi data training
```{r}
GoF(model.koyck)
```

Hasil evaluasi menunjukkan bahwa model Koyck memiliki tingkat akurasi yang baik. Pada data training, nilai MAPE sebesar 0.0149 atau sekitar 1,49%, sedangkan pada data testing nilai MAPE sebesar 0.0291 atau sekitar 2,91%. Nilai MAPE yang berada di bawah 10% mengindikasikan bahwa kesalahan peramalan model relatif sangat kecil.

# Regression with Distributed Lag
## Lag Optimum
```{r}
#penentuan lag optimum 
finiteDLMauto(formula = AQI ~ o3,
              data = data.frame(train), q.min = 1, q.max = 10,
              model.type = "dlm", error.type = "AIC", trace = TRUE)
```

Berdasarkan output tersebut, lag optimum didapatkan ketika lag=10. Selanjutnya dilakukan pemodelan untuk lag=10

```{r}
#model dlm dengan lag optimum
model.dlm2 <- dlm(x = train$o3,y = train$AQI , q = 10)
summary(model.dlm2)
```

Dari hasil tersebut terdapat beberapa peubah yang berpengaruh signifikan terhadap taraf nyata 5% yaitu $x_t$ , $x_{t-7}$ , $x_{t-8}$ , $x_{t-9}$. Adapun keseluruhan model yang terbentuk adalah

$$
\hat{Y_t}=-0.6427+0.4281X_t+...-0.09537X_{t-10}
$$

## Peramalan dan Akurasi
```{r}
fore.dlm2 <- forecast(model = model.dlm2, x=test$o3, h=14)

#akurasi data test
mape.dlm2<- MAPE(fore.dlm2$forecasts, test$AQI)
mape.dlm2
```
```{r}
#akurasi data training
GoF(model.dlm2)
```

Model Distributed Lag yang digunakan memiliki performa sangat baik baik pada data training maupun testing. Nilai MAPE yang rendah (<10%) menunjukkan bahwa model mampu memprediksi nilai AQI dengan tingkat akurasi yang sangat tinggi.

# Model Autoregressive
## Lag Optimum
```{r}
model.ardl.opt <- ardlBoundOrders(data = data.frame(data_aqi), ic = "AIC", 
                                  formula = AQI ~ o3 )
model.ardl.opt
```

```{r}
min_p=c()
for(i in 1:13){
  min_p[i]=min(model.ardl.opt$Stat.table[[i]])
}
q_opt=which(min_p==min(min_p, na.rm = TRUE))
p_opt=which(model.ardl.opt$Stat.table[[q_opt]] == 
              min(model.ardl.opt$Stat.table[[q_opt]], na.rm = TRUE))
data.frame("q_optimum" = q_opt, "p_optimum" = p_opt, 
           "AIC"=model.ardl.opt$min.Stat)
```

Dari tabel di atas, dapat terlihat bahwa nilai AIC terendah didapat ketika $p=13$ dan $q=2$, yaitu sebesar 16.55044. Artinya, model autoregressive optimum didapat ketika $p=13$ dan $q=2$.

```{r}
model.ardl2 <- ardlDlm(formula = AQI ~ o3, 
                         data = train,p = 13, q = 2)
summary(model.ardl2)
AIC(model.ardl2)
BIC(model.ardl2)
```

Hasil di atas menunjukkan bahwa selain peubah $x_{t}$, hasil uji t menunjukkan nilai-p pada peubah $\ge0.05$ Hal ini menunjukkan bahwa peubah $x_{t}$ berpengaruh signifikan terhadap $y_t$. Model keseluruhannya adalah sebagai berikut:



$$
\hat{Y_t}=-1.04456+0.407X_t+0.208X_{t-1}+...+0.14225Y_{t-2}
$$
## Peramalan dan Akurasi
```{r}
fore.ardl2 <- forecast(model = model.ardl2, x=test$o3, h=14)
fore.ardl2
```

```{r}
#akurasi data testing
mape.ardl <- MAPE(fore.ardl2$forecasts, test$AQI)
mape.ardl
#akurasi data training
GoF(model.ardl)
```

Berdasarkan akurasi di atas, terlihat bahwa model memiliki performa sangat baik baik pada data training maupun testing. Nilai MAPE yang rendah (<10%) menunjukkan bahwa model mampu memprediksi nilai AQI dengan tingkat akurasi yang sangat tinggi. Nilai MAPE keduanya tidak jauh berbeda. Artinya, model regresi dengan distribusi lag ini tidak`overfitted` atau `underfitted`. 

# Perbandingan Model
```{r}
akurasi <- matrix(c(mape.koyck, mape.dlm2, mape.ardl))
row.names(akurasi)<- c("Koyck","DLM","Autoregressive")
colnames(akurasi) <- c("MAPE")
akurasi
```
Berdasarkan nilai MAPE, model paling optimum didapat pada Model Dsitributed Lag karena memiliki nilai MAPE yang terkecil.

## Plot
```{r}
par(mfrow=c(1,1))
plot(test$o3, test$AQI, type="b", col="black", ylim=c(10,28))
points(test$o3, fore.koyck$forecasts,col="red")
lines(test$o3, fore.koyck$forecasts,col="red")
points(test$o3, fore.dlm2$forecasts,col="orange")
lines(test$o3, fore.dlm2$forecasts,col="orange")
points(test$o3, fore.ardl$forecasts,col="green")
lines(test$o3, fore.ardl$forecasts,col="green")
legend("topleft",c("aktual", "koyck","DLM", "autoregressive"), lty=1, col=c("black","red","orange","green"), cex=0.8)
```

Berdasarkan plot tersebut, terlihat bahwa plot yang paling mendekati data aktualnya adalah Model Distributed Lag dan Autoregressive, namun berdasarkan nilai MAPE, DLM memiliki nilai MAPE yang lebih kecil. Sehingga dapat disimpulkan model terbaik dalam hal ini adalah model distributed lag.

